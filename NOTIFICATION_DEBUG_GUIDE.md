# ุฏููู ุชุชุจุน ูุดููุฉ ุงูุฅุดุนุงุฑุงุช

## ุงููุดููุฉ
ุงูุฅุดุนุงุฑุงุช ุงูุชุฌุฑูุจูุฉ ูู Firebase ุชุนููุ ููู ุงูุฅุดุนุงุฑุงุช ุงูุญููููุฉ (ูุซู ุทูุจ ูุญุต ูู ุงูุฏูุชูุฑ) ูุง ุชุตู.

## ุฎุทูุงุช ุงูุชุชุจุน

### 1. ุงูุชุญูู ูู ุญูุธ FCM Token ูู ุงูุณูุฑูุฑ

#### ุฃ. ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู:
- ุงูุชุญ Render Dashboard โ Logs
- ุงุจุญุซ ุนู:
  ```
  ๐พ ========== Saving FCM token for user ==========
  ```
- ุชุญูู ูู:
  - ูู ุชู ุงุณุชุฏุนุงุก `_saveFCMToken`ุ
  - ูู FCM Token ููุฌูุฏ ูููุณ ูุงุฑุบุงูุ
  - ูู ุชู ุญูุธู ูู `additional_info` ุจุดูู ุตุญูุญุ

#### ุจ. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- ุงูุชุญ Render Dashboard โ Shell
- ูู ุจุชุดุบูู:
  ```sql
  SELECT id, name, role, additional_info->>'fcmToken' as fcm_token 
  FROM users 
  WHERE role = 'patient';
  ```
- ุชุญูู ูู ุฃู `fcm_token` ููุฌูุฏ ูููุณ `null`

### 2. ุงูุชุญูู ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุนูุฏ ุฅูุดุงุก ุทูุจ ูุญุต

#### ุฃ. ุนูุฏ ุฅูุดุงุก ุทูุจ ูุญุต:
- ุงูุชุญ Render Dashboard โ Logs
- ุงุจุญุซ ุนู:
  ```
  ๐ Lab request created - triggering notifications
  ```
- ุซู ุงุจุญุซ ุนู:
  ```
  ๐ ========== Starting lab request notifications ==========
  ```

#### ุจ. ุชุญูู ูู:
- ูู ุชู ุงุณุชุฏุนุงุก `_sendLabRequestNotifications`ุ
- ูู ุชู ุงูุนุซูุฑ ุนูู ุงููุฑูุถ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ
- ูู FCM Token ููุฌูุฏ ูู `additional_info` ูููุฑูุถุ

### 3. ุงูุชุญูู ูู Firebase V1 API

#### ุฃ. ุงูุชุญูู ูู OAuth2 Token:
- ุงุจุญุซ ูู Logs ุนู:
  ```
  ๐ Getting Firebase OAuth2 access token...
  ```
- ุชุญูู ูู:
  - ูู ุชู ุงูุญุตูู ุนูู Access Token ุจูุฌุงุญุ
  - ูู `FIREBASE_SERVICE_ACCOUNT_JSON` ููุฌูุฏ ูู Environment Variablesุ
  - ูู `FIREBASE_PROJECT_ID` ููุฌูุฏุ

#### ุจ. ุงูุชุญูู ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:
- ุงุจุญุซ ูู Logs ุนู:
  ```
  ๐ค ========== Attempting to send FCM notification ==========
  ```
- ุชุญูู ูู:
  - ูู ุชู ุฅุฑุณุงู ุงูุทูุจ ุฅูู FCMุ
  - ูุง ูู Response Status Codeุ
  - ูู ููุงู ุฃุฎุทุงุก ูู Response Bodyุ

### 4. ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูุญููููุง

#### ุฎุทุฃ 1: FCM Token ุบูุฑ ููุฌูุฏ ูููุฑูุถ
**ุงูุณุจุจ:** ุงููุฑูุถ ูู ูุณุฌู ุฏุฎูู ุจุนุฏ ุฅุนุฏุงุฏ Firebase Messaging

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุฃู ุงููุฑูุถ ุณุฌู ุฏุฎูู ุจุนุฏ ุฅุนุฏุงุฏ Firebase
2. ุชุญูู ูู ุฃู `_saveFCMTokenAfterLogin` ูุชู ุงุณุชุฏุนุงุคู ูู `auth_provider_local.dart`
3. ุฃุนุฏ ุชุณุฌูู ุงูุฏุฎูู ูููุฑูุถ

#### ุฎุทุฃ 2: Firebase Service Account ุบูุฑ ููุนุฏ
**ุงูุณุจุจ:** `FIREBASE_SERVICE_ACCOUNT_JSON` ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ุตุญูุญ

**ุงูุญู:**
1. ุงูุชุญ Render Dashboard โ Environment
2. ุชุญูู ูู ูุฌูุฏ `FIREBASE_SERVICE_ACCOUNT_JSON`
3. ุชุฃูุฏ ูู ุฃู ุงููููุฉ ูู JSON ุตุญูุญ (ูุจุฏุฃ ุจู `{` ูููุชูู ุจู `}`)
4. ุฃุนุฏ Deploy ุงูุณูุฑูุฑ

#### ุฎุทุฃ 3: Project ID ุบูุฑ ุตุญูุญ
**ุงูุณุจุจ:** `FIREBASE_PROJECT_ID` ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ุตุญูุญ

**ุงูุญู:**
1. ุงูุชุญ Render Dashboard โ Environment
2. ุฃุถู `FIREBASE_PROJECT_ID` ุจูููุฉ `shs-app-6224c`
3. ุฃุนุฏ Deploy ุงูุณูุฑูุฑ

#### ุฎุทุฃ 4: OAuth2 Token ูุดู
**ุงูุณุจุจ:** Service Account JSON ุบูุฑ ุตุญูุญ ุฃู ุบูุฑ ุตุงูุญ

**ุงูุญู:**
1. ุชุญูู ูู Service Account JSON ูู Firebase Console
2. ุชุฃูุฏ ูู ุฃู JSON ุตุญูุญ (ูุง ูุญุชูู ุนูู ุฃุณุทุฑ ุฌุฏูุฏุฉ)
3. ุฃุนุฏ ูุณุฎ JSON ูุงููุงู ุฅูู Environment Variable

### 5. ุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑุงุช

#### ุฃ. ุงุฎุชุจุงุฑ ุญูุธ FCM Token:
1. ุณุฌู ุฏุฎูู ูุญุณุงุจ ุงููุฑูุถ
2. ุงูุชุญ Render Dashboard โ Logs
3. ุงุจุญุซ ุนู:
   ```
   โ FCM token saved successfully for user
   ```

#### ุจ. ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:
1. ุณุฌู ุฏุฎูู ูุญุณุงุจ ุงูุฏูุชูุฑ
2. ุฃูุดุฆ ุทูุจ ูุญุต ุฌุฏูุฏ
3. ุงูุชุญ Render Dashboard โ Logs
4. ุงุจุญุซ ุนู:
   ```
   โ FCM V1 notification sent successfully
   ```

#### ุฌ. ุงูุชุญูู ูู ูุตูู ุงูุฅุดุนุงุฑ:
1. ุชุฃูุฏ ูู ุฃู ุงูุชุทุจูู ููุชูุญ ุนูู ุฌูุงุฒ ุงููุฑูุถ
2. ุชุญูู ูู ุฃู ุงูุฅุดุนุงุฑุงุช ููุนูุฉ ูู ุฅุนุฏุงุฏุงุช ุงูุฌูุงุฒ
3. ุงูุชุธุฑ ุจุถุน ุซูุงูู ุจุนุฏ ุฅูุดุงุก ุทูุจ ุงููุญุต

## ุณุฌูุงุช ุงูุชุชุจุน ุงููุถุงูุฉ

ุชู ุฅุถุงูุฉ ุณุฌูุงุช ุชุชุจุน ููุตูุฉ ูู:

1. **`server/lib/handlers/lab_requests_handler.dart`**:
   - ุณุฌูุงุช ุนูุฏ ุฅูุดุงุก ุทูุจ ูุญุต
   - ุณุฌูุงุช ุนูุฏ ุจุฏุก ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช
   - ุณุฌูุงุช ุนูุฏ ุงูุจุญุซ ุนู FCM Token ูููุฑูุถ
   - ุณุฌูุงุช ุนูุฏ ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุฅูู FCM

2. **`server/lib/handlers/users_handler.dart`**:
   - ุณุฌูุงุช ุนูุฏ ุญูุธ FCM Token
   - ุณุฌูุงุช ููุชุญูู ูู ุญูุธ Token ุจุดูู ุตุญูุญ

3. **`server/lib/utils/firebase_auth_helper.dart`**:
   - ุณุฌูุงุช ุนูุฏ ุงูุญุตูู ุนูู OAuth2 Token
   - ุณุฌูุงุช ุนูุฏ ูุฑุงุกุฉ Service Account JSON

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุฅุถุงูุฉ ุงูุณุฌูุงุช:
1. ุฃุนุฏ Deploy ุงูุณูุฑูุฑ ุนูู Render
2. ุงุฎุชุจุฑ ุฅูุดุงุก ุทูุจ ูุญุต ุฌุฏูุฏ
3. ุงูุชุญ Render Dashboard โ Logs
4. ุชุชุจุน ุงูุณุฌูุงุช ูุชุญุฏูุฏ ุงููุดููุฉ ุจุฏูุฉ

